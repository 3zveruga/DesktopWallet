version: 2

jobs:
  test:
    docker:
      - image: electronuserland/builder:wine-chrome
    steps:
      - checkout
      - run: apt-get -y update
      - run: apt-get -y install libusb-1.0-0-dev graphicsmagick libudev-dev
      - run: apt-get -y install tmux xvfb libxtst6 libxss1 libgtk2.0-0 libnss3 libasound2 libgconf-2-4 ffmpeg frei0r-plugins
      # TODO: Just a quick try
      - run: rm yarn.lock
      - run: yarn install
      - run:
          name: Run Webpack
          command: yarn dev
          background: true
      - run:
          name: Run Mock RPC API
          command: yarn e2e:serve
          background: true
      - run: yarn wait-on http://localhost:8080 && yarn wait-on http://localhost:18232
      - run: export DISPLAY=:99
      - run: xvfb-run --listen-tcp --server-num=99 --auth-file /tmp/xvfb.auth -s "-ac -screen 0 1024x768x24" yarn e2e:run & timeout -s SIGINT 24 ffmpeg -y -f x11grab -video_size 1024x768 -i :99 -codec:v libx264 -r 12 /tmp/e2e-record.mp4
      - store_artifacts:
          path: /tmp/e2e-record.mp4
          destination: e2e-record.mp4
workflows:
  version: 2
  test:
    jobs:
      - test:
          filters:
            branches:
              only: feature/e2e
